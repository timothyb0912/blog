<h1 id="first-things-first-protocols-type-annotations-and-unit-tests">First things first: Protocols, type annotations, and unit tests</h1>

<h2 id="motivation">Motivation</h2>

<p>Dear Young Tim,</p>

<p>Strive to be more trustworthy.
Strive to be more effective, efficient, and well-prepared for problems.
Strive to be great: to others, to your (future) self, and in how you create.
These goals complement each other.
Together, they help you “be” better, and they point to better ways of being.</p>

<p>Concretely, these goals highlight the primacy of, the need for, and the benefits of automated software testing.
Indeed, trusting your code or your results is hard without tests that provide a basic level of claim verification.
Being well prepared for coding errors is hard without tests to help pinpoint the issues.
And lastly, refactoring or extending your work is unlikely to be a great experience for your future self without tests to confirm your software’s functionality.</p>

<h2 id="the-problem">The problem</h2>
<p>Alright then.
Given its importance, you can understand why <a href="https://en.wikipedia.org/wiki/Test-driven_development#Test-driven_development_cycle">testing before coding</a> is the right thing to do.
You shouldn’t begin a journey without a way of knowing when you’ve reached your destination.
Unfortunately, purity aside, testing before coding is hard!</p>

<p>This hardness stems, in part, from uncertainty.
Without code, we are uncertain of what we should test.
Even with existing code, it can be hard to know where to begin testing.</p>

<h2 id="the-solution">The solution</h2>
<p>To address this testing barrier, we’ll remove some of our uncertainty through analysis, decision-making, and codification.
In particular, recall September’s project lifecycle <a href="https://timothyb0912.github.io/blog/philosophy/2020/09/30/Project-Lifecycle.html">description</a>.</p>

<p>We should first understand the system we want to change.
Specifically, we should perform an <a href="https://www.umsl.edu/~sauterv/analysis/488_f01_papers/quillin.htm">object analysis</a> of the system.
What are or what should be the system’s basic objects and entities?
What are their functions and attributes?</p>

<p>Next, make some design decisions: sketch the basics of how the code should function.
What functions do you call?
What objects do you instantiate?
How do those objects interact?
We’ll codify these decisions in function signatures and object protocols.</p>

<p>Finally, we’ll test to ensure that we respect our signatures and protocols throughout the codebase.
This is our most basic way to make our software trustworthy: ensuring that it does what we say it does.</p>

<h2 id="description">Description</h2>
<p>Of course, the described process will be more helpful if you know what I’m referring to.
By function signatures I’m referring to <a href="https://www.python.org/dev/peps/pep-0484/">type declarations</a> of your functions’ inputs and outputs.
Compare</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
    <span class="p">...</span>
</code></pre></div></div>
<p>versus</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_loss</span><span class="p">(</span>
  <span class="n">predictions</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span>
  <span class="n">targets</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div></div>
<p>Immediately, the second definition provides answers to questions.
What types of inputs are expected?
What types of outputs are expected?</p>

<p>By <a href="https://www.python.org/dev/peps/pep-0544/">protocols</a>, I’m referring to objects that serve as placeholders and guidelines for how other objects should look and behave.
For illustration, consider the following base class.
It defines required attributes and methods for objects that provide or implement the protocol.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>

    <span class="n">num_design_cols</span> <span class="p">:</span> <span class="nb">int</span>

    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">from_params</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">"Model"</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">num_simulations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">seed</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">25</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></div>
<p>This Protocol specifies that your model classes should have</p>
<ul>
  <li>a <code class="language-plaintext highlighter-rouge">num_design_cols</code> attribute of integer type,</li>
  <li>a <code class="language-plaintext highlighter-rouge">from_params</code> method that instantiates the class from a numpy array,</li>
  <li>a <code class="language-plaintext highlighter-rouge">predict</code> method that takes a numpy array of inputs and returns a numpy array of outputs,</li>
  <li>a <code class="language-plaintext highlighter-rouge">simulate</code> method that requires an integer number of simulations and takes an optional, integer random seed, alongside one’s input and output numpy arrays,</li>
  <li>a <code class="language-plaintext highlighter-rouge">save</code> method that takes an output path to save one’s model parameters to and returns a boolean indicating success of the process.</li>
</ul>

<p>Ideally, the attributes and functionality of one’s objects will be informed by one’s <a href="https://www.umsl.edu/~sauterv/analysis/488_f01_papers/quillin.htm">object analysis</a>.
How do you want to interact with one’s object’s?
Perhaps you wish to do the following.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">my_project</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_data</span><span class="p">,</span>
    <span class="n">load_params</span><span class="p">,</span>
    <span class="n">Model</span><span class="p">,</span>
    <span class="n">FINAL_PARAMETER_PATH</span>
<span class="p">)</span>

<span class="n">design</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">()</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">load_params</span><span class="p">()</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">.</span><span class="n">from_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">design</span><span class="p">)</span>
<span class="n">targets_simulated</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">simulate</span><span class="p">(</span>
    <span class="n">design</span><span class="p">,</span> <span class="n">num_simulations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">901</span>
<span class="p">)</span>

<span class="c1"># Further training and/or analysis
</span><span class="p">...</span>

<span class="n">model</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">FINAL_PARAMETER_PATH</span><span class="p">)</span>
</code></pre></div></div>
<p>As written, the protocol above supports such a workflow.</p>

<p>In the best case scenario, protocols will help you prototype faster.
They’ll focus your attention on high level design decisions, sans implementation details.
Thinking through and solving problems at this stage can save hours and weeks of effort later on.</p>

<p>Additionally, protocols should increase the modularity of your code.
By referring to protocols in one’s signatures, you can change any providing object’s implementation choices without affecting any other parts of one’s code, so long as the provider adheres to the protocol.
Indeed, protocol adherence enables the abstraction needed to support each provider’s uniqueness in their implementation.
Having commonality in method/attribute presence and type signature is what affords other objects/clients the luxury of ignoring the details of how each provider does what it does.</p>

<h2 id="implementation">Implementation</h2>
<p>Once we’ve defined the type signatures and protocols for our project’s functions and methods, we’re ready to begin testing.
Specifically, we should test the basics.
We’ll start with testing the “<a href="https://en.wikipedia.org/wiki/Happy_path">happy path</a>.”
Our type signatures declare that given “valid” inputs of specified types (however we define valid), we will get back outputs of specific types.
We will test that these statements are true.</p>

<p>For such contract testing (i.e., input-output type checking), the libraries <a href="https://typeguard.readthedocs.io/en/latest/userguide.html">Typeguard</a> and <a href="http://andreacensi.github.io/contracts/">PyContracts</a> should be helpful.
I especially recommend PyContracts because of it’s ability to conveniently disable all type checking when not running tests using <code class="language-plaintext highlighter-rouge">contracts.disable_all()</code>
You can get started after installation by adding the following decorator to functions in your source code with type signatures.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">contracts</span>
<span class="kn">from</span> <span class="nn">contracts</span> <span class="kn">import</span> <span class="n">contract</span>

<span class="o">@</span><span class="n">contract</span>
<span class="k">def</span> <span class="nf">my_func</span><span class="p">(</span><span class="n">arg_1</span><span class="p">:</span> <span class="n">Type1</span><span class="p">,</span> <span class="n">arg_2</span><span class="p">:</span> <span class="n">Type2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnType</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">contracts</span><span class="p">.</span><span class="n">disable_all</span><span class="p">()</span>
</code></pre></div></div>
<p>Then, one can include following tests such as the following.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">my_project</span>

<span class="k">def</span> <span class="nf">test_my_func_signature</span><span class="p">():</span>
    <span class="c1"># Define valid function arguments
</span>    <span class="n">arg_1</span> <span class="o">=</span> <span class="p">...</span>
    <span class="n">arg_2</span> <span class="o">=</span> <span class="p">...</span>

    <span class="c1"># Enable signature testing
</span>    <span class="c1"># Comment out the following line if using typeguard
</span>    <span class="n">my_project</span><span class="p">.</span><span class="n">contracts</span><span class="p">.</span><span class="n">enable_all</span><span class="p">()</span>

    <span class="c1"># Exercise the function
</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">my_project</span><span class="p">.</span><span class="n">my_func</span><span class="p">(</span><span class="n">arg_1</span><span class="p">,</span> <span class="n">arg_2</span><span class="p">)</span>
    <span class="k">return</span>
</code></pre></div></div>
<p>Alternately, one can comment out the <code class="language-plaintext highlighter-rouge">contracts.enable_all()</code> command in one’s test, keep one’s source file free of decorators, and use <code class="language-plaintext highlighter-rouge">pytest --typeguard-package=src/my_project .</code> from one’s project root to run one’s tests.
Decorating all of one’s functions is tedious and <code class="language-plaintext highlighter-rouge">typeguard</code> provides a useful workaround for such concerns.
Either way, such tests will verify that your code satisfies its advertised type signatures, at least under the tested circumstances.</p>

<p>Next, our protocols declare the necessary attributes, methods, and type signatures of our objects.
We simply need to test that our instantiated objects actually implement the protocol.
This is as simple as creating tests like the following</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">my_project</span>
<span class="kn">from</span> <span class="nn">test_fixtures</span> <span class="kn">import</span> <span class="n">load_test_inputs</span>

<span class="c1"># Enable contract testing
</span><span class="n">my_project</span><span class="p">.</span><span class="n">contracts</span><span class="p">.</span><span class="n">enable_all</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_protocol_implementation</span><span class="p">(</span>
    <span class="n">model_class</span><span class="o">=</span><span class="n">my_project</span><span class="p">.</span><span class="n">MyFancyModel</span><span class="p">,</span>
    <span class="n">model_protocol</span><span class="o">=</span><span class="n">my_project</span><span class="p">.</span><span class="n">Model</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="c1"># Replace with any alternative instantiation process if necessary
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_protocol</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">test_protocol_signatures</span><span class="p">(</span><span class="n">model_class</span><span class="o">=</span><span class="n">my_project</span><span class="p">.</span><span class="n">MyFancyModel</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">design</span> <span class="o">=</span> <span class="n">load_test_inputs</span><span class="p">()</span>
    <span class="c1"># Replace with any alternative instantiation process if necessary
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">()</span>
    <span class="c1"># Test that we can execute the function under test without error
</span>    <span class="c1"># Unexpected types on input or output we will raise an error thanks to
</span>    <span class="c1"># `contracts.enable_all()`
</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">design</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>
<p>Here, we rely on the fact that <code class="language-plaintext highlighter-rouge">isinstance(model, model_protocol)</code> will raise an error if <code class="language-plaintext highlighter-rouge">model</code> doesn’t have all of the required attributes and implement all of the methods required by <code class="language-plaintext highlighter-rouge">model_protocol</code>.
We then again rely on <code class="language-plaintext highlighter-rouge">contracts</code> to perform the actual type signature testing of our method inputs and outputs.</p>

<h2 id="extension">Extension</h2>
<p>The contract testing procedure just described is only as useful as the types it is testing for.
In particular, we will catch more of our own errors as our types become more specific.
For instance, we can catch more errors using <code class="language-plaintext highlighter-rouge">contracts</code> and</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span>
    <span class="n">targets</span><span class="p">:</span> <span class="s">"array[N], (N&gt;0, (0|1))"</span><span class="p">,</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="s">"array[N], (N&gt;0,&gt;0,&lt;1)"</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s">"int,&gt;=0"</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div></div>
<p>as compared to using standard and less specific type hints with</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>

<span class="k">def</span> <span class="nf">loss</span><span class="p">(</span>
    <span class="n">targets</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div></div>
<p>The former type signature will check for</p>
<ul>
  <li>binary values in <code class="language-plaintext highlighter-rouge">targets</code>,</li>
  <li>values in the unit interval within <code class="language-plaintext highlighter-rouge">predictions</code>,</li>
  <li>unidimensionality and equal shape of both <code class="language-plaintext highlighter-rouge">targets</code> and <code class="language-plaintext highlighter-rouge">predictions,</code></li>
  <li>and non-negative scalars as outputs.</li>
</ul>

<p>I’ve silently violated these conditions in the past, and I have spent far too much time searching for the errors because of these types of issues (all puns intended).
No more.
Note that the <a href="https://smarie.github.io/python-vtypes/">python-vtypes</a> package provides similar and even more general capabilities.
<code class="language-plaintext highlighter-rouge">python-vtypes</code> has the added ability of letting you define types that serve as drop-in replacements for regular python types, no decorators necessary.
Note that this enables <code class="language-plaintext highlighter-rouge">typeguard</code> to also check for more specific types than those natively defined in the <code class="language-plaintext highlighter-rouge">typing</code> module.</p>

<h2 id="workflow-integration">Workflow integration</h2>
<p>From the last section, you will have created detailed types.
They should encapsulate the important essence of what you expect from your object attributes, function inputs, and function outputs.
You will also have taken the advice of the <a href="##Implementation">Implementation</a> section, so you will have defined simple tests of your function signatures.
You should feel great about this!
However, you should go even further.</p>

<p>You should use your initial signature and protocol tests as a starting point for the virtuous cycle of test-driven development.
Specifically, you now have tests but no functioning code.
By design, you have failing tests.
You should now write the most minimal code that passes one of your tests.
Note, this code will likely NOT be the code that you want.
This is done purposefully.
That the incorrect function passes the tests but doesn’t do what we want means that we are missing other tests!
We should create a test suite that specifies our function’s full set of necessary conditions.
Then we’ll write code to iteratively pass each of those tests.
After this process or some number of repetitions of it, we’ll have implemented and fully tested a desired unit of code.</p>

<h2 id="example">Example</h2>
<p>With all of the above in mind, here’s a concrete example.
As with <a href="https://timothyb0912.github.io/blog/practice/2020/06/25/PyTorch-Tutorial.html">previous posts</a>, this is part of an effort to revise my paper</p>
<blockquote>
  <p>Brathwaite, Timothy. “Check yourself before you wreck yourself: Assessing discrete choice models through predictive simulations.” arXiv preprint arXiv:1806.02307 (2018).</p>
</blockquote>

<p>Here was the context.
When trying to understand estimated models, I become Picasso.
Well, not the same, but I do make pictures.
Plots, specifically.
Lots of them.</p>

<p>I decided to share this code in a python package, <a href="https://github.com/timothyb0912/checkrs">Checkrs</a>.
It would be great to be able to automatically test that my functions plot what they say they are plotting.
Unfortunately, writing unit tests for matplotlib is a <a href="https://towardsdatascience.com/unit-testing-python-data-visualizations-18e0250430">terrible experience</a>.
Since <a href="https://altair-viz.github.io/">Altair</a> can output plots in a standardized <a href="http://vega.github.io/vega-lite/">Vega-Lite</a> JSON, I figured it would be easy to test.</p>

<p>To get started in porting my matplotlib functions to Altair, I followed the process described above.
I started by defining protocols of the basic objects: the chart.
I called it a view because I think of each chart as one way to view one’s data.
This protocol would therefore be a base object for all charts.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">attr</span><span class="p">.</span><span class="n">s</span>
<span class="k">class</span> <span class="nc">View</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="s">"""
    Base class for Checkrs visualizations. Provides a view of one's data.
    """</span>
    <span class="n">theme</span> <span class="p">:</span> <span class="n">PlotTheme</span>

    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">from_chart_data</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">ChartData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">"View"</span><span class="p">:</span>
        <span class="s">"""
        Instantiates the view from the given `ChartData`.
        """</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ViewObject</span><span class="p">:</span>
        <span class="s">"""
        Renders the view of the data using a specified backend.
        """</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""
        Saves the view of the data using the appropriate backend for the
        filename's extension. Returns True if saving succeeded.
        """</span>
        <span class="k">pass</span>
</code></pre></div></div>
<p>It’s the basics.</p>
<ul>
  <li>I need to instantiate the chart from data,</li>
  <li>I need to store the styling options for the plot (<code class="language-plaintext highlighter-rouge">theme</code>),</li>
  <li>I need to draw the chart using some library (<code class="language-plaintext highlighter-rouge">backend</code>),</li>
  <li>and I need to save the chart.</li>
</ul>

<p>Protocol in hand, I wrote the basic tests.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_draw_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        GIVEN a chart instantiated with valid_chart_data
        WHEN we call the draw method with any valid keyword-argument
        THEN we receive the appropriate matplotlib.Figure or an altair.Chart
        """</span>
        <span class="k">for</span> <span class="n">backend</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">backends</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">charts_all</span><span class="p">):</span>
            <span class="n">chart</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">from_chart_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">manipulable_object</span> <span class="o">=</span> <span class="n">chart</span><span class="p">.</span><span class="n">draw</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">manipulable_object</span><span class="p">,</span> <span class="p">(</span><span class="n">ggplot</span><span class="p">,</span> <span class="n">TopLevelMixin</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_save_functionality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        GIVEN a chart instantiated with valid_chart_data
        WHEN we call the save method with any valid keyword-argument
        THEN the appropriate file will be saved to its appropriate location
        AND we will be returned a boolean indicating saving success
        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">temp_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">temp_dir</span><span class="p">)</span>  <span class="c1"># Make a directory to hold the test plots
</span>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">"test_filename"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">extensions</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">charts_all</span><span class="p">):</span>
                <span class="n">chart</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">from_chart_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">full_path_current</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="c1"># Ensure missing file, create the file, ensure existing file
</span>                <span class="bp">self</span><span class="p">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path_current</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">chart</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">full_path_current</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path_current</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Clear up test plots even if failure happens
</span>            <span class="n">shutil</span><span class="p">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>
<p>I’m of course skipping details of these tests, but the basic points are the following.
<code class="language-plaintext highlighter-rouge">self.charts_all</code> is a list of <code class="language-plaintext highlighter-rouge">View</code>s.
Then, <code class="language-plaintext highlighter-rouge">chart = view.from_chart_data(data=self.data)</code> tests the constructor method.
It also tests whether the implementing class has a theme and the methods defined by <code class="language-plaintext highlighter-rouge">View</code>.
Next, one function tests <code class="language-plaintext highlighter-rouge">chart.draw</code> and another function tests <code class="language-plaintext highlighter-rouge">chart.save</code>.
This fully tests the protocol. Have a look at the following three files for all the details of the <a href="https://github.com/timothyb0912/checkrs/blob/stable/src/checkrs/base.py">protocol construction</a>, implementing <a href="https://github.com/timothyb0912/checkrs/blob/stable/src/checkrs/sim_cdf.py#L279">chart construction</a>, and <a href="https://github.com/timothyb0912/checkrs/blob/stable/tests/unit/test_chart_protocol.py">tests</a>.</p>

<p>To top it off, I set up Github Actions <a href="https://github.com/timothyb0912/checkrs/blob/stable/.github/workflows/testing.yml">workflow</a> to perform the tests and display the results automatically upon pushing changes to the package repository.
Both the original tests and the continuous testing via Github increase the package’s trustworthiness.
So, despite having to learn by fire along the way, it’s a win in the end!</p>

<p><img src="https://media2.giphy.com/media/3o6vY7UsuMPx3Yj9Xa/giphy.gif" alt="&quot;Losses to Learnings&quot;" /></p>
